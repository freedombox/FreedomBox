---
# SPDX-License-Identifier: AGPL-3.0-or-later

.run-functional-tests:
  stage: functional-tests
  needs: []
  dependencies: []
  tags:
    - functional-tests
  timeout: 10h
  # Need to find another way of running the cleanup step even on failure
  allow_failure: true
  except:
    - $GITLAB_USER_LOGIN == "weblate"
  before_script:
    - apt-get update
    - apt-get -y install make
    - make provision-dev
    - sudo -u plinth ./run --develop > plinth.log 2>&1 &
    - while ! grep -q "Setup finished" plinth.log; do sleep 1; echo -n .; done
  script:
    - FREDOMBOX_URL=https://localhost FREEDOMBOX_SSH_PORT=22 FREEDOMBOX_SAMBA_PORT=445 pytest -v --durations=10 --include-functional --splinter-headless --instafail --template=html1/index.html --report=functional-tests.html
  artifacts:
    when: always
    paths:
      - functional-tests.html
      - screenshots/
      - plinth.log
